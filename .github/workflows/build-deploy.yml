name: Build and Deploy GELIS DELIVERY

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies for all apps
      run: |
        npm ci
        cd customer-app && npm ci
        cd ../partner-app && npm ci
        cd ../driver-app && npm ci
        cd ../admin-panel && npm ci

    - name: Fix PostCSS configurations
      run: |
        # Fix PostCSS config for all apps
        for app in customer-app partner-app driver-app admin-panel; do
          echo "Fixing PostCSS for $app"
          cat > $app/postcss.config.js << 'EOF'
        export default {
          plugins: {
            '@tailwindcss/postcss': {},
            autoprefixer: {},
          },
        }
        EOF
        done

    - name: Copy shared files to apps
      run: |
        # Copy shared files to prevent import errors
        for app in customer-app partner-app driver-app admin-panel; do
          cp shared/firebaseServices.js $app/src/
          cp shared/config.js $app/src/
        done

    - name: Fix import paths in customer-app
      run: |
        # Fix import paths for customer-app
        sed -i 's|../firebaseServices.js|./firebaseServices.js|g' customer-app/src/contexts/AuthContext.jsx
        sed -i 's|../config.js|./config.js|g' customer-app/src/contexts/AuthContext.jsx
        sed -i 's|../firebaseServices.js|./firebaseServices.js|g' customer-app/src/pages/HomePage.jsx

    - name: Build Customer App
      run: |
        cd customer-app
        npm run build

    - name: Build Partner App
      run: |
        cd partner-app
        npm run build

    - name: Build Driver App
      run: |
        cd driver-app
        npm run build

    - name: Build Admin Panel
      run: |
        cd admin-panel
        npm run build

    - name: Create deployment structure
      run: |
        # Create dist folder structure
        mkdir -p dist/customer dist/partner dist/driver dist/admin

        # Copy build files
        cp -r customer-app/dist/* dist/customer/
        cp -r partner-app/dist/* dist/partner/
        cp -r driver-app/dist/* dist/driver/
        cp -r admin-panel/dist/* dist/admin/

        # Copy main landing page and .htaccess
        cp dist/index.html dist/index.html 2>/dev/null || echo "Landing page will be created in next step"

    - name: Create landing page if not exists
      run: |
        # Create landing page if it doesn't exist
        if [ ! -f dist/index.html ]; then
          cat > dist/index.html << 'EOF'
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GELIS DELIVERY - Platform Layanan Pesan Antar Makanan</title>
    <meta name="description" content="GELIS DELIVERY - Platform layanan pesan antar makanan terpadu">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="mb-8">
                <i class="fas fa-utensils text-6xl text-red-600 mb-4"></i>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">GELIS DELIVERY</h1>
                <p class="text-xl text-gray-600">Platform Layanan Pesan Antar Makanan</p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">Aplikasi Kami</h2>
                <div class="grid grid-cols-2 gap-4">
                    <a href="customer/" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-mobile-alt text-2xl mb-2"></i>
                        <p>Customer App</p>
                    </a>
                    <a href="partner/" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-store text-2xl mb-2"></i>
                        <p>Partner App</p>
                    </a>
                    <a href="driver/" class="bg-yellow-600 text-white p-4 rounded-lg hover:bg-yellow-700 transition">
                        <i class="fas fa-motorcycle text-2xl mb-2"></i>
                        <p>Driver App</p>
                    </a>
                    <a href="admin/" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-cogs text-2xl mb-2"></i>
                        <p>Admin Panel</p>
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
        fi

    - name: Create .htaccess file
      run: |
        cat > dist/.htaccess << 'EOF'
# GELIS DELIVERY - Hostinger Configuration
RewriteEngine On

# Customer App Routing
RewriteCond %{REQUEST_URI} ^/customer [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^customer/(.*)$ customer/index.html [L,QSA]

# Partner App Routing
RewriteCond %{REQUEST_URI} ^/partner [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^partner/(.*)$ partner/index.html [L,QSA]

# Driver App Routing
RewriteCond %{REQUEST_URI} ^/driver [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^driver/(.*)$ driver/index.html [L,QSA]

# Admin Panel Routing
RewriteCond %{REQUEST_URI} ^/admin [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^admin/(.*)$ admin/index.html [L,QSA]

# Redirects
RewriteRule ^customer$ customer/ [R=301,L]
RewriteRule ^partner$ partner/ [R=301,L]
RewriteRule ^driver$ driver/ [R=301,L]
RewriteRule ^admin$ admin/ [R=301,L]

# Handle 404 errors
ErrorDocument 404 /index.html
EOF

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gelis-delivery-build
        path: dist/
        retention-days: 30

    - name: Build summary
      run: |
        echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Customer App: Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Partner App: Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Driver App: Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Admin Panel: Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Landing Page: Created" >> $GITHUB_STEP_SUMMARY
        echo "âœ… .htaccess: Configured for Hostinger" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‚ Deployment Structure" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "dist/" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ index.html (Landing Page)" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ .htaccess (Hostinger Config)" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ customer/ (Customer App)" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ partner/ (Partner App)" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ driver/ (Driver App)" >> $GITHUB_STEP_SUMMARY
        echo "â””â”€â”€ admin/ (Admin Panel)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the build artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Upload the \`dist\` folder to your Hostinger hosting" >> $GITHUB_STEP_SUMMARY
        echo "3. The applications will be available at:" >> $GITHUB_STEP_SUMMARY
        echo "   - Main: https://gelis-delivery.cloud/" >> $GITHUB_STEP_SUMMARY
        echo "   - Customer: https://gelis-delivery.cloud/customer/" >> $GITHUB_STEP_SUMMARY
        echo "   - Partner: https://gelis-delivery.cloud/partner/" >> $GITHUB_STEP_SUMMARY
        echo "   - Driver: https://gelis-delivery.cloud/driver/" >> $GITHUB_STEP_SUMMARY
        echo "   - Admin: https://gelis-delivery.cloud/admin/" >> $GITHUB_STEP_SUMMARY

  deploy-preview:
    if: github.event_name == 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: gelis-delivery-build
        path: dist/

    - name: Preview deployment info
      run: |
        echo "## ðŸ“‹ Preview Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This PR build has been completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To deploy this build:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the artifacts from this workflow" >> $GITHUB_STEP_SUMMARY
        echo "2. Upload the \`dist\` folder to your hosting provider" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Preview URLs" >> $GITHUB_STEP_SUMMARY
        echo "- Landing Page: \`/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Customer App: \`/customer/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Partner App: \`/partner/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Driver App: \`/driver/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Admin Panel: \`/admin/\`" >> $GITHUB_STEP_SUMMARY