name: Build GELIS DELIVERY

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Build Customer App
      run: |
        cd customer-app
        cp ../shared/firebaseServices.js src/
        cp ../shared/config.js src/
        npm ci
        npm run build

    - name: Build Partner App
      run: |
        cd partner-app
        cp ../shared/firebaseServices.js src/
        cp ../shared/config.js src/
        npm ci
        npm run build

    - name: Build Driver App
      run: |
        cd driver-app
        cp ../shared/firebaseServices.js src/
        cp ../shared/config.js src/
        npm ci
        npm run build

    - name: Build Admin Panel
      run: |
        cd admin-panel
        cp ../shared/firebaseServices.js src/
        cp ../shared/config.js src/
        npm ci
        npm run build

    - name: Create deployment structure
      run: |
        rm -rf dist
        mkdir -p dist

        cp -r customer-app/dist/* dist/
        mkdir -p dist/partner dist/driver dist/admin
        cp -r partner-app/dist/* dist/partner/
        cp -r driver-app/dist/* dist/driver/
        cp -r admin-panel/dist/* dist/admin/

    - name: Create apps selection page
      run: |
        mkdir -p dist/apps
        cat > dist/apps/index.html << 'HTML_EOF'
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps - GELIS DELIVERY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
        <div class="text-center mb-8">
            <div class="mb-4">
                <i class="fas fa-utensils text-6xl text-red-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">GELIS DELIVERY</h1>
            <p class="text-gray-600">Pilih Aplikasi</p>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6 space-y-4">
            <a href="/partner/" class="block w-full bg-green-600 text-white text-center py-3 px-4 rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-store mr-2"></i>Partner Dashboard
            </a>
            <a href="/driver/" class="block w-full bg-yellow-600 text-white text-center py-3 px-4 rounded-lg hover:bg-yellow-700 transition">
                <i class="fas fa-motorcycle mr-2"></i>Driver App
            </a>
            <a href="/admin/" class="block w-full bg-purple-600 text-white text-center py-3 px-4 rounded-lg hover:bg-purple-700 transition">
                <i class="fas fa-cogs mr-2"></i>Admin Panel
            </a>
        </div>
        <div class="text-center mt-6">
            <a href="/" class="text-blue-600 hover:text-blue-700">
                <i class="fas fa-arrow-left mr-2"></i>Kembali ke Customer App
            </a>
        </div>
    </div>
</body>
</html>
HTML_EOF

    - name: Create .htaccess
      run: cp .htaccess.template dist/.htaccess

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gelis-delivery-production
        path: dist/
        retention-days: 30

    - name: Build Summary
      run: |
        echo "## âœ… GELIS DELIVERY - Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All 4 applications have been built successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- **Customer App**: https://gelis-delivery.cloud/ (Main app)" >> $GITHUB_STEP_SUMMARY
        echo "- **Partner Dashboard**: https://gelis-delivery.cloud/partner/" >> $GITHUB_STEP_SUMMARY
        echo "- **Driver App**: https://gelis-delivery.cloud/driver/" >> $GITHUB_STEP_SUMMARY
        echo "- **Admin Panel**: https://gelis-delivery.cloud/admin/" >> $GITHUB_STEP_SUMMARY
        echo "- **Apps Menu**: https://gelis-delivery.cloud/apps/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Ready for Hostinger Auto-Deploy!" >> $GITHUB_STEP_SUMMARY
        echo "Build artifacts are ready for automatic deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Customer App** is set as the main page (root domain)" >> $GITHUB_STEP_SUMMARY
        echo "**No more blank page!**" >> $GITHUB_STEP_SUMMARY